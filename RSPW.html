<!DOCTYPE html>
<html>

<head>
  <title>Gestionnaire de Données RAZIA SARL</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
  font-family: sans-serif;
}

h1 {
  text-align: center;
}

h2 {
  text-align: center;
}

form {
  display: grid;
  background-color: #8186f9;
  border: 5px solid blue;
  grid-template-columns: repeat(2, 1fr); /* Deux colonnes pour les écrans plus grands */
  gap: 20px;
  padding: 10px;
  border-radius: 10px;
}

label {
  display: block;
  margin-bottom: 10px;
  font-size: 18px;
  font-weight: bold;
}

input[type="text"],
input[type="number"],
select,
input[type="date"] {
  width: 100%;
  padding: 10px;
  border: 3px solid black;
  box-sizing: border-box;
  border-radius: 7px;
}

button {
  background-color: blue;
  color: white;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  border-radius: 10px;
  font-size: 20px;
}

/* Ajout de styles pour les boutons */
.button-container {
  margin-top: 20px;
  /* Espacement au-dessus des boutons */
}

.button-container button {
  margin-right: 30px;
  /* Espacement entre les boutons */
}

#ajouterBtn {
  margin-bottom: 30px;
  /* Espacement sous le bouton "Ajouter" */
}

table {
  width: 95%; /* Réduit la largeur du tableau à 95% */
  border-collapse: collapse;
  margin-top: 20px;
  margin-left: auto; /* Centre le tableau horizontalement */
  margin-right: 20px;
}

th,
td {
  border: 2px solid black;
  padding: 8px;
  text-align: left;
}

th {
  background-color: #8186f9;
  text-align: center;
}

/* Cacher les sections par défaut */
#detailsSection,
#tendancesSection,
#analysesSection,
#creanciersSection,
#stocksSection {
  display: none;
}

/* Style pour la barre de chargement */
#loadingBar {
  width: 0%;
  height: 5px;
  background-color: green;
  transition: width 0.5s ease-in-out;
}

/* Media Queries pour les smartphones */
@media (max-width: 600px) {
  form {
    grid-template-columns: 1fr; /* Une seule colonne pour les smartphones */
    gap: 15px;
  }

  input[type="text"],
  input[type="number"],
  select,
  input[type="date"] {
    padding: 18px; /* Augmentation significative du padding */
    font-size: 16px;
    height: 35px
  }

  /* Assurer que le champ de type "date" est suffisamment grand */
  input[type="date"] {
    -webkit-appearance: none; /* Supprimer l'apparence par défaut */
    -moz-appearance: none;
    appearance: none;
    height: 35px; /* Hauteur fixe pour le champ de date */
  }

  .button-container button {
    padding: 12px 24px; /* Augmentation du padding des boutons */
    font-size: 18px;
    margin-bottom: 10px;
    width: 100%;
  }

  table {
    font-size: 14px; /* Réduire la taille de la police du tableau */
    width: 100%; /* Ajustement de la largeur du tableau pour les smartphones */
  }

  th,
  td {
    padding: 6px; /* Réduire le padding des cellules du tableau */
  }
}

/* Supprimer les flèches de spin pour les champs de type number */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Style pour le numéro de téléphone en rouge si RAP > 0 */
#produitTable td:nth-child(22) {
  /* Sélectionne la 22ème colonne (Numéro de Téléphone) */
  color: black;
  /* Couleur de base en noir */
}

#produitTable tbody tr td:nth-child(22) {
  /* Sélectionne la 22ème colonne dans le corps du tableau */
  color: red;
  /* Couleur rouge si RAP > 0 */
}

/* Style pour le numéro de téléphone en noir si RAP = 0 */
#produitTable tbody tr td:nth-child(22):not([data-rap-status="red"]) {
  color: black;
}
  </style>
</head>

<body>

  <h1>Gestionnaire de Données RAZIA SARL</h1>
  <h2>Ajouter un nouveau produit</h2>

  <form id="productForm">
    <!-- Chaque champ occupe maintenant sa propre ligne -->
    <div>
      <label for="date">Date:</label>
      <input type="date" id="date" name="date" required>
    </div>
    <div>
      <label for="quantite">Quantité:</label>
      <input type="number" id="quantite" name="quantite" required oninput="calculerTauxCroissance()">
    </div>
    <div>
      <label for="designation">Désignation:</label>
      <select id="designation" name="designation">
        <!-- Les options seront ajoutées ici -->
      </select>
    </div>
    <div>
      <label for="typeArticle">Type d'Article:</label>
      <select id="typeArticle" name="typeArticle">
        <option value="Ancien">Ancien</option>
        <option value="Nouveau">Nouveau</option>
      </select>
    </div>
    <div>
      <label for="categorie">Catégorie:</label>
      <input type="text" id="categorie" name="categorie">
    </div>
    <div>
      <label for="prixVente">Prix de vente:</label>
      <input type="number" id="prixVente" name="prixVente" oninput="calculerMargeBenefice()">
    </div>
    <div>
      <label for="RAP">RAP:</label>
      <input type="number" id="RAP" name="RAP" oninput="changerCouleurTelephone()">
    </div>
    <div>
      <label for="prixBrut">Prix brut:</label>
      <input type="number" id="prixBrut" name="prixBrut" oninput="calculerPrixNet()">
    </div>
    <div>
      <label for="taux">Taux:</label>
      <input type="number" id="taux" name="taux" oninput="calculerPrixNet()">
    </div>
    <div>
      <label for="netBrut">Prix Net :</label>
      <input type="number" id="netBrut" name="netBrut" readonly>
    </div>
    <div>
      <label for="freight">Freight:</label>
      <input type="number" id="freight" name="freight" oninput="calculerCoutReviens()">
    </div>
    <div>
      <label for="douaneTransport">Douane et Transport:</label>
      <input type="number" id="douaneTransport" name="douaneTransport" oninput="calculerCoutReviens()">
    </div>
    <div>
      <label for="fraisTransfert">Frais de transfert et Tenue de Compte:</label>
      <input type="number" id="fraisTransfert" name="fraisTransfert" oninput="calculerCoutReviens()">
    </div>
    <div>
      <label for="impotDocument">Impôt et Document:</label>
      <input type="number" id="impotDocument" name="impotDocument" oninput="calculerCoutReviens()">
    </div>
    <div>
      <label for="reparation">Réparation:</label>
      <input type="number" id="reparation" name="reparation" oninput="calculerCoutReviens()">
    </div>
    <div>
      <label for="typeClient">Type de Client:</label>
      <select id="typeClient" name="typeClient">
        <option value="Ancien">Ancien</option>
        <option value="Nouveau">Nouveau</option>
      </select>
    </div>
    <div>
      <label for="ville">Ville:</label>
      <input type="text" id="ville" name="ville">
    </div>
    <div>
      <label for="numeroTelephone">Numéro de Téléphone:</label>
      <input type="text" id="numeroTelephone" name="numeroTelephone">
    </div>
    <div>
      <label for="commande">Commande:</label>
      <input type="number" id="commande" name="commande">
    </div>
    <div>
      <label for="coutReviens">Coût de Reviens du Produit:</label>
      <input type="number" id="coutReviens" name="coutReviens" readonly>
    </div>
    <div>
      <label for="margeBenefice">Marge Bénéfice:</label>
      <input type="number" id="margeBenefice" name="margeBenefice" readonly>
    </div>
  </form>

  <div class="button-container">
    <button id="ajouterBtn" onclick="ajouterProduit()">Ajouter</button><br>
    <button onclick="afficherDetails()">Détails des Données</button>
    <button onclick="afficherAnalyses()">Analyses des Données</button>
    <button onclick="afficherTendances()">Tendances des Données</button>
    <button onclick="afficherCreanciers()">Débuteurs</button>
    <button onclick="afficherStocks()">Gestion de Stocks</button>
  </div>

  <!-- Barre de chargement -->
  <div id="loadingBar"></div>

  <!-- Section des détails avec le tableau -->
  <div id="detailsSection">
    <h2>Tableau des Données</h2>
    <table id="produitTable">
      <thead>
        <tr>
          <th colspan="1">Données de base</th>
          <th colspan="6">Informations du produit</th>
          <th colspan="3">Prix d'achat</th>
          <th colspan="5">Autre Dépense</th>
          <th rowspan="2">Total des Dépenses</th>
          <th colspan="2">Informations Financières</th>
          <th colspan="4">Marketing et Clients</th>
          <th colspan="1"></th>
        </tr>
        <tr>
          <th>Date</th>
          <th>Quantité</th>
          <th>Désignation</th>
          <th>Type d'Article</th>
          <th>Catégorie</th>
          <th>Prix de vente</th>
          <th>RAP</th>
          <th>Prix Brut</th>
          <th>Taux</th>
          <th>Prix Net</th>
          <th>Freight</th>
          <th>Douane et Transport</th>
          <th>Frais de Transfert et Tenue de Compte</th>
          <th>Impôt et Document</th>
          <th>Réparation</th>
          <th>Coût de Reviens du Produit</th>
          <th>Marge Bénéfice</th>
          <th>Type de Client</th>
          <th>Ville</th>
          <th>Commande</th>
          <th>Numéro de Téléphone</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les lignes de produits seront ajoutées ici -->
      </tbody>
    </table>
  </div>

  <!-- Section des tendances avec le graphique -->
  <div id="tendancesSection">
    <h2>Tendances des Produits</h2>
    <canvas id="tendanceChart"></canvas>
  </div>

  <!-- Section des analyses -->
  <div id="analysesSection">
    <h2>Analyses des Produits</h2>
    <div>
      <label for="analysePeriode">Période d'analyse:</label>
      <select id="analysePeriode">
        <option value="hebdomadaire">Hebdomadaire</option>
        <option value="mensuelle">Mensuelle</option>
        <option value="annuelle">Annuelle</option>
      </select>
    </div>
    <div id="resultatsAnalyse">
      <!-- Les résultats de l'analyse seront affichés ici -->
    </div>
  </div>

  <!-- Section des créanciers -->
  <div id="creanciersSection">
    <h2>Liste des Débuteurs</h2>
    <table id="creancierTable">
      <thead>
        <tr>
          <th>Désignation</th>
          <th>Numéro de Téléphone</th>
          <th>Montant RAP</th>
          <th>Satut</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les lignes des créanciers seront ajoutées ici -->
      </tbody>
    </table>
  </div>

  <!-- Section de l'inventaire de stocks -->
  <div id="stocksSection">
    <h2>Inventaire de Stocks</h2>
    <form id="stockForm">
      <div>
        <label for="designationStock">Désignation:</label>
        <input type="text" id="designationStock" name="designationStock" required>
      </div>
      <div>
        <label for="quantiteInitialeStock">Quantité Initiale:</label>
        <input type="number" id="quantiteInitialeStock" name="quantiteInitialeStock" required>
      </div>
      <button onclick="ajouterStock()">Ajouter Stock</button>
    </form>
    <table id="stockTable">
      <thead>
        <tr>
          <th>Désignation</th>
          <th>Quantité Initiale</th>
          <th>Quantité Restante</th>
          <th>Quantité Vendues</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les lignes de stocks seront ajoutées ici -->
      </tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="text/javascript">
    // Initialisez Firebase (remplacez les valeurs par vos propres identifiants)
    var firebaseConfig = {
      apiKey: "AIzaSyDTxa2nD-EVgmSRrHWciqs7xdOkp12t5yA",
      authDomain: "razia-sarl.firebaseapp.com",
      databaseURL: "https://razia-sarl-default-rtdb.firebaseio.com",
      projectId: "razia-sarl",
      storageBucket: "razia-sarl.appspot.com",
      messagingSenderId: "490482635351",
      appId: "1:490482635351:web:fc82421e1907576a090912",
      measurementId: "G-Q2EWH7HJ8T"
    };
    firebase.initializeApp(firebaseConfig);

    var database = firebase.database();
    var produitsRef = database.ref('produits'); // Référence à la collection 'produits'
    var creanciersRef = database.ref('creanciers'); // Référence à la collection 'creanciers'
    var stocksRef = database.ref('stocks'); // Référence à la collection 'stocks'

    // Fonction pour ajouter un produit (modifiée pour ajouter le créancier)
    function ajouterProduit() {
      // Vérifier si tous les champs sont remplis
      var inputs = document.getElementById("productForm").querySelectorAll("input, select");
      for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].value === "") {
          alert("Veuillez remplir tous les champs du formulaire.");
          return; // Arrêter l'exécution de la fonction
        }
      }

      // Afficher la barre de chargement
      document.getElementById("loadingBar").style.width = "0%";

      var productData = {
        date: document.getElementById("date").value,
        quantite: document.getElementById("quantite").value,
        designation: document.getElementById("designation").value,
        typeArticle: document.getElementById("typeArticle").value,
        categorie: document.getElementById("categorie").value,
        prixVente: document.getElementById("prixVente").value,
        RAP: document.getElementById("RAP").value,
        netBrut: document.getElementById("netBrut").value,
        prixBrut: document.getElementById("prixBrut").value,
        taux: document.getElementById("taux").value,
        freight: document.getElementById("freight").value,
        douaneTransport: document.getElementById("douaneTransport").value,
        fraisTransfert: document.getElementById("fraisTransfert").value,
        impotDocument: document.getElementById("impotDocument").value,
        reparation: document.getElementById("reparation").value,
        typeClient: document.getElementById("typeClient").value,
        ville: document.getElementById("ville").value,
        numeroTelephone: document.getElementById("numeroTelephone").value,
        commande: document.getElementById("commande").value,
        coutReviens: parseFloat(document.getElementById("coutReviens").value) || 0, // Ajout du champ coutReviens
        margeBenefice: parseFloat(document.getElementById("margeBenefice").value) || 0, // Ajout du champ margeBenefice
      };

      database.ref('produits').push(productData)
        .then(function() {
          // Animer la barre de chargement
          document.getElementById("loadingBar").style.width = "100%";

          // Attendre une courte durée pour que l'animation se termine
          setTimeout(function() {
            alert("Produit ajouté avec succès !");
            document.getElementById("productForm").reset();
            document.getElementById("loadingBar").style.width = "0%"; // Réinitialiser la barre de chargement
            mettreAJourStocks(productData.designation, productData.quantite);

            // Vérifier si RAP > 0 pour ajouter un créancier
            if (parseFloat(productData.RAP) > 0) {
              // Ajouter le créancier à la liste des créanciers après l'ajout du produit
              creanciersRef.push({
                date: productData.date,
                designation: productData.designation,
                numeroTelephone: productData.numeroTelephone,
                RAP: productData.RAP
              });
            }
          }, 500); // Attendre 500 millisecondes (0.5 seconde)
        })
        .catch(function(error) {
          console.error("Erreur lors de l'ajout du produit:", error);
          alert("Une erreur est survenue.");
          document.getElementById("loadingBar").style.width = "0%"; // Réinitialiser la barre de chargement en cas d'erreur
        });
    }

    function afficherDetails() {
      var detailsSection = document.getElementById("detailsSection");
      var tendancesSection = document.getElementById("tendancesSection");
      var analysesSection = document.getElementById("analysesSection");
      var creanciersSection = document.getElementById("creanciersSection");
      var stocksSection = document.getElementById("stocksSection");

      detailsSection.style.display = "block"; // Afficher les détails
      tendancesSection.style.display = "none"; // Cacher les tendances
      analysesSection.style.display = "none"; // Cacher les analyses
      creanciersSection.style.display = "none"; // Cacher la liste des créanciers
      stocksSection.style.display = "none"; // Cacher la liste des stocks
      remplirTableau(); // Remplir le tableau avec les données
    }

    function remplirTableau() {
      var productTable = document.getElementById("produitTable").getElementsByTagName('tbody')[0];
      productTable.innerHTML = ''; // Effacer le contenu du tableau

      database.ref('produits').orderByChild('date').limitToLast(100).once('value') // Trier par date (les plus récents en haut)
        .then(function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var product = childSnapshot.val();
            var row = productTable.insertRow();

            // Date
            var dateCell = row.insertCell();
            dateCell.textContent = product.date;

            // Quantité
            var quantiteCell = row.insertCell();
            quantiteCell.textContent = product.quantite;

            // Désignation
            var designationCell = row.insertCell();
            designationCell.textContent = product.designation;

            // Type d'Article
            var typeArticleCell = row.insertCell();
            typeArticleCell.textContent = product.typeArticle;

            // Catégorie
            var categorieCell = row.insertCell();
            categorieCell.textContent = product.categorie;

            // Prix de vente
            var prixVenteCell = row.insertCell();
            prixVenteCell.textContent = product.prixVente;

            // RAP
            var RAPCell = row.insertCell();
            RAPCell.textContent = product.RAP;

            // Prix Brut
            var prixBrutCell = row.insertCell();
            prixBrutCell.textContent = product.prixBrut;

            // Taux
            var tauxCell = row.insertCell();
            tauxCell.textContent = product.taux;

            // Prix Net
            var netBrutCell = row.insertCell();
            netBrutCell.textContent = product.netBrut;

            // Freight
            var freightCell = row.insertCell();
            freightCell.textContent = product.freight;

            // Douane et Transport
            var douaneTransportCell = row.insertCell();
            douaneTransportCell.textContent = product.douaneTransport;

            // Frais de transfert et Tenue de Compte
            var fraisTransfertCell = row.insertCell();
            fraisTransfertCell.textContent = product.fraisTransfert;

            // Impôt et Document
            var impotDocumentCell = row.insertCell();
            impotDocumentCell.textContent = product.impotDocument;

            // Réparation
            var reparationCell = row.insertCell();
            reparationCell.textContent = product.reparation;

            // Calculer le total des dépenses
            var totalDepenses = parseFloat(product.freight) +
              parseFloat(product.douaneTransport) +
              parseFloat(product.fraisTransfert) +
              parseFloat(product.impotDocument) +
              parseFloat(product.reparation);

            // Total
            var totalCell = row.insertCell();
            totalCell.textContent = totalDepenses.toFixed(2); // Afficher le total avec 2 décimales

            // Coût de Reviens du Produit
            var coutReviensCell = row.insertCell();
            coutReviensCell.textContent = product.coutReviens;

            // Marge Bénéfice
            var margeBeneficeCell = row.insertCell();
            margeBeneficeCell.textContent = product.margeBenefice;

            // Type de Client
            var typeClientCell = row.insertCell();
            typeClientCell.textContent = product.typeClient;

            // Ville
            var villeCell = row.insertCell();
            villeCell.textContent = product.ville;

            // Commande
            var commandeCell = row.insertCell();
            commandeCell.textContent = product.commande;

            // Numéro de Téléphone
            var numeroTelephoneCell = row.insertCell();
            numeroTelephoneCell.textContent = product.numeroTelephone;
            // Ajout d'un attribut pour le statut RAP
            numeroTelephoneCell.setAttribute('data-rap-status', product.RAP > 0 ? 'red' : 'black');
          });
        })
        .catch(function(error) {
          console.error("Erreur lors de la récupération des détails des produits:", error);
          alert("Une erreur est survenue.");
        });
    }

    var tendanceChart = null; // Variable pour stocker l'objet du graphique

    function afficherTendances() {
      var detailsSection = document.getElementById("detailsSection");
      var tendancesSection = document.getElementById("tendancesSection");
      var analysesSection = document.getElementById("analysesSection");
      var creanciersSection = document.getElementById("creanciersSection");
      var stocksSection = document.getElementById("stocksSection");

      detailsSection.style.display = "none"; // Cacher les détails
      tendancesSection.style.display = "block"; // Afficher les tendances
      analysesSection.style.display = "none"; // Cacher les analyses
      creanciersSection.style.display = "none"; // Cacher la liste des créanciers
      stocksSection.style.display = "none"; // Cacher la liste des stocks
      creerGraphique(); // Créer le graphique
    }

        function creerGraphique() {
      // Récupérer les données de Firebase pour le graphique
      produitsRef.on('value', function(snapshot) {
        var labels = [];
        var quantiteData = [];
        var commandeData = [];
        var coutReviensData = [];
        var margeBeneficeData = [];
        var tauxCroissanceData = [];

        snapshot.forEach(function(childSnapshot) {
          var product = childSnapshot.val();
          labels.push(product.date);
          quantiteData.push(parseFloat(product.quantite) || 0);
          commandeData.push(parseFloat(product.commande) || 0);
          coutReviensData.push(parseFloat(product.coutReviens) || 0);
          margeBeneficeData.push(parseFloat(product.margeBenefice) || 0);
          tauxCroissanceData.push(parseFloat(product.tauxCroissance) || 0);
        });

        // Mettre à jour le graphique existant avec les nouvelles données
        if (tendanceChart) {
          tendanceChart.data.labels = labels;
          tendanceChart.data.datasets[0].data = quantiteData;
          tendanceChart.data.datasets[1].data = commandeData;
          tendanceChart.data.datasets[2].data = coutReviensData;
          tendanceChart.data.datasets[3].data = margeBeneficeData;
          tendanceChart.data.datasets[4].data = tauxCroissanceData;
          tendanceChart.update();
        } else {
          // Créer le graphique si il n'existe pas encore
          var ctx = document.getElementById('tendanceChart').getContext('2d');
          tendanceChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                  label: 'Quantité',
                  data: quantiteData,
                  borderColor: 'rgba(54, 162, 235, 1)',
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  borderWidth: 1
                },
                {
                  label: 'Commande',
                  data: commandeData,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderWidth: 1
                },
                {
                  label: 'Coût de Reviens',
                  data: coutReviensData,
                  borderColor: 'rgba(255, 206, 86, 1)',
                  backgroundColor: 'rgba(255, 206, 86, 0.2)',
                  borderWidth: 1
                },
                {
                  label: 'Marge Bénéfice',
                  data: margeBeneficeData,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  borderWidth: 1
                },
                {
                  label: 'Taux de croissance',
                  data: tauxCroissanceData,
                  borderColor: 'rgba(153, 102, 255, 1)',
                  backgroundColor: 'rgba(153, 102, 255, 0.2)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      });
    }

    function calculerTauxCroissance() {
      var quantiteActuelle = parseFloat(document.getElementById("quantite").value) || 0;
      var dateActuelle = new Date(document.getElementById("date").value);

      // Trouver la quantité du mois précédent dans Firebase
      database.ref('produits')
        .orderByChild('date')
        .endAt(dateActuelle.getFullYear() + '-' + (dateActuelle.getMonth()) + '-01') // Exclure le mois actuel
        .limitToLast(1) // Récupérer le dernier enregistrement du mois précédent
        .once('value')
        .then(function(snapshot) {
          var quantitePrecedente = 0;
          snapshot.forEach(function(childSnapshot) {
            quantitePrecedente = parseFloat(childSnapshot.val().quantite) || 0;
          });

          // Calculer le taux de croissance
          var tauxCroissance = 0;
          if (quantitePrecedente !== 0) {
            tauxCroissance = ((quantiteActuelle - quantitePrecedente) / quantitePrecedente) * 100;
          }

          // Afficher le taux de croissance dans le champ
          document.getElementById("tauxCroissance").value = tauxCroissance.toFixed(2);
        })
        .catch(function(error) {
          console.error("Erreur lors du calcul du taux de croissance:", error);
        });
    }

    function calculerCoutReviens() {
      var netBrut = parseFloat(document.getElementById("netBrut").value) || 0;
      var freight = parseFloat(document.getElementById("freight").value) || 0;
      var douaneTransport = parseFloat(document.getElementById("douaneTransport").value) || 0;
      var fraisTransfert = parseFloat(document.getElementById("fraisTransfert").value) || 0;
      var impotDocument = parseFloat(document.getElementById("impotDocument").value) || 0;
      var reparation = parseFloat(document.getElementById("reparation").value) || 0;

      var coutReviens = netBrut + freight + douaneTransport + fraisTransfert + impotDocument + reparation;
      document.getElementById("coutReviens").value = coutReviens.toFixed(2);

      calculerMargeBenefice(); // Mettre à jour la marge bénéficiaire
    }

    function calculerMargeBenefice() {
      var prixVente = parseFloat(document.getElementById("prixVente").value) || 0;
      var coutReviens = parseFloat(document.getElementById("coutReviens").value) || 0;

      var margeBenefice = prixVente - coutReviens;
      document.getElementById("margeBenefice").value = margeBenefice.toFixed(2);
    }

    function afficherAnalyses() {
      var detailsSection = document.getElementById("detailsSection");
      var tendancesSection = document.getElementById("tendancesSection");
      var analysesSection = document.getElementById("analysesSection");
      var creanciersSection = document.getElementById("creanciersSection");
      var stocksSection = document.getElementById("stocksSection");

      detailsSection.style.display = "none"; // Cacher les détails
      tendancesSection.style.display = "none"; // Cacher les tendances
      analysesSection.style.display = "block"; // Afficher les analyses
      creanciersSection.style.display = "none"; // Cacher la liste des créanciers
      stocksSection.style.display = "none"; // Cacher la liste des stocks

      // Appeler la fonction d'analyse avec la période par défaut (mensuelle)
      analyserProduits("mensuelle");
    }

    function analyserProduits(periode) {
      var resultatsAnalyse = document.getElementById("resultatsAnalyse");
      resultatsAnalyse.innerHTML = ''; // Effacer les résultats précédents

      database.ref('produits').once('value')
        .then(function(snapshot) {
          var donneesAnalyse = {}; // Objet pour stocker les données d'analyse

          snapshot.forEach(function(childSnapshot) {
            var product = childSnapshot.val();
            var date = new Date(product.date);

            // Déterminer la clé pour la période d'analyse
            var clePeriode = "";
            if (periode === "hebdomadaire") {
              // Numéro de la semaine
              clePeriode = "Semaine " + getWeekNumber(date);
            } else if (periode === "mensuelle") {
              // Mois et année
              clePeriode = date.toLocaleString('default', {
                month: 'long',
                year: 'numeric'
              });
            } else if (periode === "annuelle") {
              // Année
              clePeriode = date.getFullYear();
            }

            // Initialiser les données pour la période si nécessaire
            if (!donneesAnalyse[clePeriode]) {
              donneesAnalyse[clePeriode] = {
                quantite: 0,
                commande: 0,
                coutReviens: 0,
                margeBenefice: 0,
                totalVente: 0 // Nouveau champ pour le total des ventes
              };
            }

            // Ajouter les données du produit aux données de la période
            donneesAnalyse[clePeriode].quantite += parseFloat(product.quantite) || 0;
            donneesAnalyse[clePeriode].commande += parseFloat(product.commande) || 0;
            donneesAnalyse[clePeriode].coutReviens += parseFloat(product.coutReviens) || 0;
            donneesAnalyse[clePeriode].margeBenefice += parseFloat(product.margeBenefice) || 0;
            donneesAnalyse[clePeriode].totalVente += parseFloat(product.prixVente) || 0; // Mettre à jour le total des ventes

          });

              // Calculer le taux de croissance pour chaque mois
          var moisPrecedent = null;
          for (var cle in donneesAnalyse) {
            var donnees = donneesAnalyse[cle];
            if (moisPrecedent) {
              var tauxCroissance = 0;
              if (donneesAnalyse[moisPrecedent].totalVente !== 0) {
                tauxCroissance = ((donnees.totalVente - donneesAnalyse[moisPrecedent].totalVente) / donneesAnalyse[moisPrecedent].totalVente) * 100;
              }
              donnees.tauxCroissance = tauxCroissance.toFixed(2); // Ajouter le taux de croissance aux données du mois
            }
            moisPrecedent = cle; // Enregistrer le mois actuel pour le calcul du prochain mois
          }

          // Afficher les résultats de l'analyse
          for (var cle in donneesAnalyse) {
            var donnees = donneesAnalyse[cle];
            var resultatDiv = document.createElement('div');
            resultatDiv.innerHTML = '<h3>' + cle + '</h3>' +
              '<p>Quantité: ' + donnees.quantite.toFixed(2) + '</p>' +
              '<p>Commande: ' + donnees.commande.toFixed(2) + '</p>' +
              '<p>Coût de Reviens: ' + donnees.coutReviens.toFixed(2) + '</p>' +
              '<p>Marge Bénéfice: ' + donnees.margeBenefice.toFixed(2) + '</p>';
            if (donnees.tauxCroissance) { // Afficher le taux de croissance si disponible
              resultatDiv.innerHTML += '<p>Taux de croissance: ' + donnees.tauxCroissance + '%</p>';
            }
            resultatsAnalyse.appendChild(resultatDiv);
          }
        })
        .catch(function(error) {
          console.error("Erreur lors de la récupération des données pour l'analyse:", error);
          alert("Une erreur est survenue.");
        });
    }

    // Fonction pour obtenir le numéro de la semaine
    function getWeekNumber(d) {
      // Copier la date pour ne pas modifier l'original
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      // Définir le jour de la semaine à jeudi dans la ligne de temps locale
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      // Obtenir le premier jour de l'année
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      // Calculer le numéro de la semaine
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // Écouteur d'événement pour le changement de période d'analyse
    document.getElementById("analysePeriode").addEventListener('change', function() {
      analyserProduits(this.value);
    });

    // Fonction pour calculer le prix net
    function calculerPrixNet() {
      var prixBrut = parseFloat(document.getElementById("prixBrut").value) || 0;
      var taux = parseFloat(document.getElementById("taux").value) || 0;
      var prixNet = prixBrut * taux;
      document.getElementById("netBrut").value = prixNet.toFixed(2);
    }

    // Fonction pour changer la couleur du numéro de téléphone
    function changerCouleurTelephone() {
      var RAP = parseFloat(document.getElementById("RAP").value) || 0;
      var numeroTelephoneInput = document.getElementById("numeroTelephone");
      if (RAP > 0) {
        numeroTelephoneInput.style.color = 'red';
      } else {
        numeroTelephoneInput.style.color = 'black';
      }
    }

    // Fonction pour afficher la liste des créanciers
    function afficherCreanciers() {
      var detailsSection = document.getElementById("detailsSection");
      var tendancesSection = document.getElementById("tendancesSection");
      var analysesSection = document.getElementById("analysesSection");
      var creanciersSection = document.getElementById("creanciersSection");
      var stocksSection = document.getElementById("stocksSection");

      detailsSection.style.display = "none"; // Cacher les détails
      tendancesSection.style.display = "none"; // Cacher les tendances
      analysesSection.style.display = "none"; // Cacher les analyses
      creanciersSection.style.display = "block"; // Afficher la liste des créanciers
      stocksSection.style.display = "none"; // Cacher la liste des stocks
      remplirTableauCreanciers(); // Remplir le tableau des créanciers
    }

    // Fonction pour remplir le tableau des créanciers
    function remplirTableauCreanciers() {
      var creancierTable = document.getElementById("creancierTable").getElementsByTagName('tbody')[0];
      creancierTable.innerHTML = ''; // Effacer le contenu du tableau

      creanciersRef.orderByChild('date').limitToLast(100).once('value') // Trier par date (les plus récents en haut)
        .then(function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var creancier = childSnapshot.val();
            var row = creancierTable.insertRow();

            // Désignation
            var designationCell = row.insertCell();
            designationCell.textContent = creancier.designation;

            // Numéro de Téléphone
            var numeroTelephoneCell = row.insertCell();
            numeroTelephoneCell.textContent = creancier.numeroTelephone;

            // Montant RAP
            var RAPCell = row.insertCell();
            RAPCell.textContent = creancier.RAP;

            // Bouton Payé
            var payéCell = row.insertCell();
            var payéButton = document.createElement("button");
            payéButton.textContent = "Payé";
            payéButton.onclick = function() {
              // Supprimer la ligne du tableau des créanciers
              row.remove();

              // Mettre à jour la couleur du numéro de téléphone dans le tableau des données
              mettreAJourTelephone(creancier.numeroTelephone, 'black');

              // Supprimer le créancier de Firebase
              creanciersRef.child(childSnapshot.key).remove();

              // Mettre à jour le montant RAP du produit dans Firebase
              mettreAJourRAP(creancier.numeroTelephone, 0);
            };
            payéCell.appendChild(payéButton);
          });
        })
        .catch(function(error) {
          console.error("Erreur lors de la récupération des détails des créanciers:", error);
          alert("Une erreur est survenue.");
        });
    }

    // Fonction pour mettre à jour la couleur du numéro de téléphone dans le tableau des données
    function mettreAJourTelephone(numeroTelephone, couleur) {
      var produitTable = document.getElementById("produitTable").getElementsByTagName('tbody')[0];
      var rows = produitTable.querySelectorAll('tr');

      rows.forEach(function(row) {
        var numeroTelephoneCell = row.querySelector('td:nth-child(22)'); // Sélectionne la cellule du numéro de téléphone
        if (numeroTelephoneCell.textContent === numeroTelephone) {
          numeroTelephoneCell.style.color = couleur;
          // Supprimer l'attribut data-rap-status pour réinitialiser la coloration
          numeroTelephoneCell.removeAttribute('data-rap-status');
        }
      });
    }

    // Fonction pour mettre à jour le montant RAP du produit dans Firebase
    function mettreAJourRAP(numeroTelephone, nouveauRAP) {
      produitsRef.orderByChild('numeroTelephone').equalTo(numeroTelephone).once('value', function(produitSnapshot) {
        if (produitSnapshot.exists()) {
          produitSnapshot.forEach(function(childSnapshot) {
            produitsRef.child(childSnapshot.key).update({
              RAP: nouveauRAP
            });
          });
        }
      });
    }

    // Lorsque des données sont ajoutées à la collection 'produits'
    produitsRef.on('child_added', function(snapshot) {
      var product = snapshot.val();

      // Vérifier si RAP > 0
      if (parseFloat(product.RAP) > 0) {
        // Ajouter le créancier à la liste des créanciers
        ajouterCreancier(product); // Appeler la fonction pour ajouter le créancier
      }
    });

    // Mettre à jour le tableau des créanciers si un produit est modifié
    produitsRef.on('child_changed', function(snapshot) {
      var product = snapshot.val();
      mettreAJourCreancier(product);
    });

    // Fonction pour mettre à jour les créanciers en fonction des modifications de produits
    function mettreAJourCreancier(product) {
      // Vérifier si RAP > 0
      if (parseFloat(product.RAP) > 0) {
        // Vérifier si le créancier existe déjà dans la liste
        creanciersRef.orderByChild('numeroTelephone').equalTo(product.numeroTelephone).once('value', function(creancierSnapshot) {
          if (creancierSnapshot.exists()) {
            // Mettre à jour le créancier existant
            creancierSnapshot.forEach(function(childSnapshot) {
              creanciersRef.child(childSnapshot.key).update({
                date: product.date,
                designation: product.designation,
                RAP: product.RAP
              });
            });
          } else {
            // Ajouter le créancier à la liste des créanciers
            creanciersRef.push({
              date: product.date,
              designation: product.designation,
              numeroTelephone: product.numeroTelephone,
              RAP: product.RAP
            });
          }

          // Mettre à jour la couleur du numéro de téléphone dans le tableau des données
          mettreAJourTelephone(product.numeroTelephone, 'red');
        });
      } else {
        // Vérifier si le créancier existe déjà dans la liste
        creanciersRef.orderByChild('numeroTelephone').equalTo(product.numeroTelephone).once('value', function(creancierSnapshot) {
          if (creancierSnapshot.exists()) {
            // Supprimer le créancier de la liste
            creancierSnapshot.forEach(function(childSnapshot) {
              creanciersRef.child(childSnapshot.key).remove();
            });

            // Mettre à jour la couleur du numéro de téléphone dans le tableau des données
            mettreAJourTelephone(product.numeroTelephone, 'black');
          }
        });
      }
    }

    // Fonction pour afficher la section "Gestion de Stocks"
    function afficherStocks() {
      var detailsSection = document.getElementById("detailsSection");
      var tendancesSection = document.getElementById("tendancesSection");
      var analysesSection = document.getElementById("analysesSection");
      var creanciersSection = document.getElementById("creanciersSection");
      var stocksSection = document.getElementById("stocksSection");

      detailsSection.style.display = "none"; // Cacher les détails
      tendancesSection.style.display = "none"; // Cacher les tendances
      analysesSection.style.display = "none"; // Cacher les analyses
      creanciersSection.style.display = "none"; // Cacher la liste des créanciers
      stocksSection.style.display = "block"; // Afficher la liste des stocks
      remplirTableauStocks(); // Remplir le tableau des stocks
    }

    // Fonction pour remplir le tableau des stocks
    function remplirTableauStocks() {
      var stockTable = document.getElementById("stockTable").getElementsByTagName('tbody')[0];
      stockTable.innerHTML = ''; // Effacer le contenu du tableau

      stocksRef.once('value')
        .then(function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var stock = childSnapshot.val();
            var row = stockTable.insertRow();

            // Désignation
            var designationCell = row.insertCell();
            designationCell.textContent = stock.designation;

            // Quantité Initiale
            var quantiteInitialeCell = row.insertCell();
            quantiteInitialeCell.textContent = stock.quantiteInitiale;

            // Quantité Restante
            var quantiteRestanteCell = row.insertCell();
            quantiteRestanteCell.textContent = stock.quantiteRestante;

            // Quantité Vendues
            var quantiteVenduesCell = row.insertCell();
            quantiteVenduesCell.textContent = stock.quantiteInitiale - stock.quantiteRestante; // Calculer la quantité vendues
          });
        })
        .catch(function(error) {
          console.error("Erreur lors de la récupération des données des stocks:", error);
          alert("Une erreur est survenue.");
        });
    }

    // Fonction pour mettre à jour les stocks lors de l'ajout d'un produit
    function mettreAJourStocks(designation, quantite) {
      stocksRef.orderByChild('designation').equalTo(designation).once('value', function(stockSnapshot) {
        if (stockSnapshot.exists()) {
          stockSnapshot.forEach(function(childSnapshot) {
            var stock = childSnapshot.val();
            var key = childSnapshot.key;

            // Calculer la quantité restante et la quantité vendues
            var nouvelleQuantiteRestante = stock.quantiteRestante - quantite;
            var nouvelleQuantiteVendues = stock.quantiteInitiale - nouvelleQuantiteRestante; // Calculer la quantité vendues

            // Mettre à jour les données du stock
            stocksRef.child(key).update({
              quantiteRestante: nouvelleQuantiteRestante,
              quantiteVendues: nouvelleQuantiteVendues // Mettre à jour la quantité vendues
            });
          });
        } else {
          // Créer un nouveau stock si le produit n'existe pas encore
          stocksRef.push({
            designation: designation,
            quantiteInitiale: quantite, // La quantité initiale est la quantité ajoutée
            quantiteRestante: quantite,
            quantiteVendues: 0 // Initialiser la quantité vendues à 0
          });
        }
      });
    }

    // Fonction pour ajouter un stock
    function ajouterStock() {
      var designation = document.getElementById("designationStock").value;
      var quantiteInitiale = parseFloat(document.getElementById("quantiteInitialeStock").value) || 0;

      // Vérifier si tous les champs sont remplis
      if (designation === "" || isNaN(quantiteInitiale)) {
        alert("Veuillez remplir tous les champs du formulaire de stock.");
        return;
      }

      // Ajouter le stock à Firebase
      stocksRef.push({
        designation: designation,
        quantiteInitiale: quantiteInitiale,
        quantiteRestante: quantiteInitiale,
        quantiteVendues: 0 // Initialiser la quantité vendues à 0
      })
      .then(function() {
        // Réinitialiser le formulaire
        document.getElementById("stockForm").reset();
        // Mettre à jour le tableau des stocks
        remplirTableauStocks();
        alert("Stock ajouté avec succès !");
      })
      .catch(function(error) {
        console.error("Erreur lors de l'ajout du stock:", error);
        alert("Une erreur est survenue.");
      });
    }

    // Fonction pour remplir le champ de sélection "Désignation"
    function remplirChampDesignation() {
      var designationSelect = document.getElementById("designation");
      designationSelect.innerHTML = ''; // Effacer les options existantes

      // Récupérer les désignations des stocks depuis Firebase
      stocksRef.once('value')
        .then(function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var stock = childSnapshot.val();
            var option = document.createElement("option");
            option.value = stock.designation;
            option.text = stock.designation;
            designationSelect.add(option);
          });
        })
        .catch(function(error) {
          console.error("Erreur lors de la récupération des données des stocks:", error);
          alert("Une erreur est survenue.");
        });
    }

    // Appeler la fonction pour remplir le champ de sélection au chargement de la page
    window.onload = function() {
      remplirTableauStocks();
      remplirChampDesignation();
    };
  </script>

</body>

</html>
