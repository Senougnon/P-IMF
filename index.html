<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme de Microfinance</title>
    <style type="text/css">
      /* Styles généraux */
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f4;
}

.container {
  width: 80%;
  margin: 20px auto;
  background-color: #fff;
  padding: 20px;
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

h1,
h2 {
  text-align: center;
  margin-bottom: 20px;
}

/* Styles des onglets */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
  border-radius: 5px;
  display: flex; /* Aligne les boutons sur la même ligne */
  flex-wrap: wrap; /* Permet aux boutons de s'envelopper sur plusieurs lignes si nécessaire */
}

.tablinks {
  background-color: #4CAF50;
  color: white;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px 12px; /* Réduction du padding */
  transition: background-color 0.3s;
  font-size: 14px; /* Réduction de la taille de la police */
  margin-bottom: 10px; 
  flex: 1 0 45%; /* Chaque bouton prend 45% de la largeur, minimum 45% */
}

.tablinks:hover {
  background-color: #45a049;
}

.tablinks.active {
  background-color: #45a049;
}

.tabcontent {
  display: none;
  padding: 20px;
  border-top: none;
}

/* Styles des formulaires */
form {
  margin-top: 20px;
}

.form-field {
  margin-bottom: 10px;
}

label {
  display: block;
  margin-bottom: 5px;
}

/* Styles pour les champs de saisie */
input[type="text"],
input[type="date"],
input[type="number"],
select {
  width: 100%;
  padding: 10px;
  border: 2px solid black;
  border-radius: 5px;
  box-sizing: border-box;
}

/* Style des boutons d'enregistrement */
button[type="submit"] {
  background-color: #0000FF;
  color: #ffd700; /* Texte or */
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  font-size: 18px;
  display: block;
  margin: 0 auto;
  margin-bottom: 10px;
}

/* Styles du tableau des détails */
#detailsTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

#detailsTable th,
#detailsTable td {
  text-align: left;
  padding: 8px;
  border: 1px solid #ccc;
}

#detailsTable th {
  background-color: #f2f2f2;
}

#totalAdherentsOperations {
  margin-top: 20px;
  font-weight: bold;
}

/* Styles pour le conteneur du graphique */
#chart {
  width: 100%;
  height: 400px;
  margin-top: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

/* Styles pour le formulaire d'adhérent */
#adherentForm {
  margin-top: 20px;
  background-color: #F9E892;
  padding: 20px;
  border-radius: 5px;
}

/* Styles pour le formulaire d'enregistrement des opérations */
#operationForm {
  margin-top: 20px;
  background-color: #F9E892;
  padding: 20px;
  border-radius: 5px;
}

/* Styles pour le formulaire d'enregistrement des partenaires */
#partenaireForm {
  margin-top: 20px;
  background-color: #F9E892;
  padding: 20px;
  border-radius: 5px;
}

/* Styles pour la barre de chargement */
.loading {
  display: none;
  width: 100%;
  height: 20px;
  background-color: #eee;
  border-radius: 5px;
  margin-top: 10px;
  overflow: hidden;
}

.bar {
  height: 100%;
  background-color: #4caf50;
  width: 0%;
  transition: width 0.5s ease-in-out;
}

/* Styles pour les analyses */
.analysis-section {
  margin-top: 20px;
}

/* Styles pour les champs en ligne */
.inline-fields .form-field {
  display: inline-block;
  width: 32%;
  margin-right: 1%;
}

/* Style spécifique pour le champ de fichier */
.inline-fields .form-field input[type="file"] {
  width: 90%;
}

/* Nouvelle règle pour supprimer les bordures */
.no-border input[type="file"] {
  border: none;
}

/* Styles pour le carrousel d'images */
#imageCarousel {
  width: 100%;
  overflow: hidden;
  margin-bottom: 20px;
}

#imageCarousel img {
  width: 100%;
  height: auto;
  display: none;
  border-radius: 10px;
}

#imageCarousel img.active {
  display: block;
}

/* Styles des boutons des détails */
#details .tablinks {
  background-color: #0000FF;
  color: #ffd700;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px 20px;
  transition: background-color 0.3s;
  font-size: 17px;
  display: inline-block;
  margin: 10px 5px;
  border-radius: 5px;
  font-weight: bold;
}

#details .tablinks:hover {
  background-color: #e6c300;
}

/* Styles pour les écrans de moins de 768 pixels de large */
@media (max-width: 768px) { 
  .container {
    width: 95%;
    padding: 10px; 
  }

  .tablinks {
    font-size: 14px;
    padding: 10px 12px; 
  }

  .inline-fields .form-field {
    display: block; 
    width: 100%; 
    margin-right: 0;
  }

  h2 {
    font-size: 1.5em; 
  }

  /* Raccourcir le texte du bouton "Tendances graphiques" */
  .tablinks[onclick="openTab(event, 'tendances')"] .long-text {
    display: none;
  }

  .tablinks[onclick="openTab(event, 'tendances')"] .short-text {
    display: inline;
  }
}

/* Style pour le total général en gras et plus grand */
#detailsGlobaux p:last-of-type { /* Sélectionne le dernier paragraphe de detailsGlobaux */
  font-weight: bold;
  font-size: 1.2em;
}

/* Styles pour l'onglet d'analyse */
#analyses {
  margin-top: 20px;
}

#analyses h2 {
  text-align: center;
}

#analyses .period-selection {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

#analyses .period-selection label {
  margin-right: 10px;
}

#analyses .period-selection select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

#analyses .analysis-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

#analyses .analysis-table th,
#analyses .analysis-table td {
  text-align: left;
  padding: 8px;
  border: 1px solid #ccc;
}

#analyses .analysis-table th {
  background-color: #f2f2f2;
}

/* Styles pour les données d'analyse en gras */
#analyses .analysis-table td.total {
  font-weight: bold;
}
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Plateforme de Microfinance</h1>

        <div id="imageCarousel">
            <img src="https://firebasestorage.googleapis.com/v0/b/microfinance-68811.appspot.com/o/Image%20Accueil%2FImage%20IMF1.jpeg?alt=media&token=030dc305-b724-4a41-aca7-f0d345ab8bb2" alt="Image 1">
            <img src="https://firebasestorage.googleapis.com/v0/b/microfinance-68811.appspot.com/o/Image%20Accueil%2FImage%20IMF2.jpg?alt=media&token=3079599f-1df1-4ba1-b93b-b9a928b8d4be" alt="Image 2">
            <img src="https://firebasestorage.googleapis.com/v0/b/microfinance-68811.appspot.com/o/Image%20Accueil%2FImage%20IMF3.jpg?alt=media&token=5168ccfa-4e2d-4560-a312-26b6cf6ec03f" alt="Image 3">
            <img src="https://firebasestorage.googleapis.com/v0/b/microfinance-68811.appspot.com/o/Image%20Accueil%2FImage%20IMF4.jpg?alt=media&token=538ce237-86a8-40db-9a76-40fec275cf65" alt="Image 4">
        </div>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'adherents')">Enregistrement des Adhérents</button>
            <button class="tablinks" onclick="openTab(event, 'operations')">Enregistrement des Opérations & Partenaires</button>
            <button class="tablinks" onclick="openTab(event, 'details')">Détails Généraux</button>
            <button class="tablinks" onclick="openTab(event, 'tendances')">
                <span class="long-text">Tendances graphiques</span>
                <span class="short-text">Graphiques</span>
            </button>
        </div>

        <div id="adherents" class="tabcontent">
            <h2>Enregistrement des Adhérents</h2>
            <form id="adherentForm">
                <div class="inline-fields">
                    <div class="form-field">
                        <label for="civilite">Civilité:</label>
                        <select id="civilite" required>
                            <option value="">Sélectionnez</option>
                            <option value="Monsieur">Monsieur</option>
                            <option value="Madame">Madame</option>
                            <option value="Mademoiselle">Mademoiselle</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="dateNaissance">Date de naissance:</label>
                        <input type="date" id="dateNaissance" required>
                    </div>
                    <div class="form-field">
                        <label for="lieuNaissance">Lieu de naissance:</label>
                        <input type="text" id="lieuNaissance" required>
                    </div>
                </div>
                <div class="form-field">
                    <label for="nom">Nom et Prénoms:</label>
                    <input type="text" id="nom" required>
                </div>

                <div class="inline-fields">
                    <div class="form-field">
                        <label for="adresse">Adresse:</label>
                        <input type="text" id="adresse" required>
                    </div>
                    <div class="form-field">
                        <label for="telephone">N° de Téléphone:</label>
                        <input type="text" id="telephone" required>
                    </div>
                    <div class="form-field">
                        <label for="situationMatrimoniale">Situation Matrimoniale:</label>
                        <select id="situationMatrimoniale" required>
                            <option value="">Sélectionnez</option>
                            <option value="Célibataire">Célibataire</option>
                            <option value="Marié(e)">Marié(e)</option>
                            <option value="Divorcé(e)">Divorcé(e)</option>
                            <option value="Veuf(ve)">Veuf(ve)</option>
                        </select>
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-field">
                        <label for="pieceIdentite">N° de Pièce d'Identité:</label>
                        <input type="text" id="pieceIdentite" required>
                    </div>
                    <div class="form-field no-border">
                        <label for="pieceIdentiteFile">Joindre une copie de la Pièce d'Identité:</label>
                        <input type="file" id="pieceIdentiteFile">
                    </div>
                </div>

                <h3>Informations de la Personne à Contacter</h3>
                <div class="form-field">
                    <label for="contactNom">Nom et Prénoms:</label>
                    <input type="text" id="contactNom" required>
                </div>
                <div class="inline-fields">
                    <div class="form-field">
                        <label for="contactAdresse">Adresse:</label>
                        <input type="text" id="contactAdresse" required>
                    </div>
                    <div class="form-field">
                        <label for="contactTelephone">N° de Téléphone:</label>
                        <input type="text" id="contactTelephone" required>
                    </div>
                    <div class="form-field">
                        <label for="contactPieceIdentite">N° de Pièce d'Identité:</label>
                        <input type="text" id="contactPieceIdentite" required>
                    </div>
                </div>
                <div class="form-field no-border"> 
                    <label for="contactPieceIdentiteFile">Joindre une copie de la Pièce d'Identité de la personne à contacter:</label> 
                    <input type="file" id="contactPieceIdentiteFile"> 
                </div>
                <div id="adherentLoading" class="loading">
                    <div class="bar"></div>
                </div>

                <button type="submit">Enregistrer l'adhérent</button>
            </form>
        </div>

        <div id="operations" class="tabcontent">
            <h2>Enregistrement des Opérations</h2>
            <form id="operationForm">
                <div class="form-field">
                    <label for="typeOperation">Type d'opération:</label>
                    <select id="typeOperation" required onchange="afficherTypeOperation()">
                        <option value="">Sélectionnez</option>
                        <option value="mise">Mise</option>
                        <option value="pret">Prêt</option>
                        <option value="tontine">Tontine</option>
                        <option value="FraisAdhesion">Frais d'Adhésion</option>
                    </select>
                </div>

                <div class="form-field" id="typeTontineField" style="display: none;">
                  <label for="typeTontine">Type de Tontine:</label>
                  <select id="typeTontine">
                    <option value="Depot">Dépôt</option>
                    <option value="Retrait">Retrait</option>
                  </select>
                </div>

                <div class="form-field" id="typePretField" style="display: none;">
                    <label for="typePret">Type de Prêt:</label>
                    <select id="typePret" onchange="afficherPeriodiciteDelai()">
                      <option value="Pret">Prêt</option>
                      <option value="Remboursement">Remboursement</option>
                      <option value="Interet">Intérêt</option>
                      <option value="Penalite">Pénalité</option>
                      <option value="FraisDossier">Frais de dossier</option>
                    </select>
                </div>

                <div class="form-field" id="periodiciteField" style="display: none;">
                    <label for="periodicite">Périodicité:</label>
                    <select id="periodicite">
                      <option value="Hebdomadaire">Hebdomadaire</option>
                      <option value="Mensuelle">Mensuelle</option>
                      <option value="Annuelle">Annuelle</option>
                    </select>
                  </div>
              
                  <div class="form-field" id="delaiPaiementField" style="display: none;">
                    <label for="delaiPaiement">Délai de Paiement (en jours):</label>
                    <input type="number" id="delaiPaiement">
                  </div>

                <div class="form-field">
                    <label for="adherent">Adhérent:</label>
                    <select id="adherent" required>
                        <!-- Les options seront remplies dynamiquement -->
                    </select>
                </div>
                <div class="form-field">
                    <label for="montant">Montant:</label>
                    <input type="number" id="montant" required>
                </div>
                <div class="form-field">
                    <label for="dateOperation">Date:</label>
                    <input type="date" id="dateOperation" required>
                </div>

                <div id="operationLoading" class="loading">
                    <div class="bar"></div>
                </div>

                <button type="submit">Enregistrer l'opération</button>
            </form>

            <h2>Enregistrement des Partenaires</h2>
            <form id="partenaireForm">
                <div class="form-field">
                    <label for="nomPartenaire">Nom et Prénoms du Partenaire:</label>
                    <input type="text" id="nomPartenaire" required>
                </div>
                <div class="form-field">
                    <label for="montantPartenariat">Montant du Partenariat:</label>
                    <input type="number" id="montantPartenariat" required>
                </div>
                <div class="form-field">
                    <label for="datePartenariat">Date de Partenariat:</label>
                    <input type="date" id="datePartenariat" required>
                </div>
                <div class="form-field">
                    <label for="tauxRemuneration">Taux de Rémunération:</label>
                    <input type="number" id="tauxRemuneration" required>
                </div>
                <div class="form-field">
                    <label for="dateFin">Date de Fin:</label>
                    <input type="date" id="dateFin" required>
                </div>

                <div id="partenaireLoading" class="loading">
                    <div class="bar"></div>
                </div>

                <button type="submit">Enregistrer le Partenaire</button>
            </form>
        </div>

        <div id="details" class="tabcontent">
            <h2>Détails des adhérents</h2>
            <table id="detailsTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Total des mises</th>
                        <th>Total des prêts</th>
                        <th>Total des tontines</th>
                        <th>Total général</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les lignes seront remplies dynamiquement -->
                </tbody>
            </table>
            <div id="totalAdherentsOperations">
                Total Général des Opérations : <span id="totalGeneralOperations">0</span> FCFA
            </div>

            <button class="tablinks" onclick="afficherDetailsGlobaux()">Détails Globaux</button>
            <button class="tablinks" onclick="openTab(event, 'analyses')">Analyses Périodiques</button>

            <div id="detailsGlobaux" style="display: none;">
                <h2>Détails globaux</h2>
                <p>Total des mises : <span id="totalMises">0</span> FCFA</p>
                <p>Total des prêts : <span id="totalPrets">0</span> FCFA</p>
                <p>Total des remboursements : <span id="totalRemboursements">0</span> FCFA</p>
                <p>Total des frais de dossier : <span id="totalFraisDossier">0</span> FCFA</p>
                <p>Total des frais d'adhésion : <span id="totalFraisAdhesion">0</span> FCFA</p>
                <p>Total des intérêts : <span id="totalInterets">0</span> FCFA</p>
                <p>Total des pénalités : <span id="totalPenalites">0</span> FCFA</p>
                <p>Total des dépôts de tontines : <span id="totalDepotsTontines">0</span> FCFA</p>
                <p>Total des retraits de tontines : <span id="totalRetraitsTontines">0</span> FCFA</p>
                <p>Total des tontines : <span id="totalTontines">0</span> FCFA</p>
                <p>Total des Commissions : <span id="totalCommissions">0</span> FCFA</p>
                <p>Nombre d'adhérents : <span id="nombreAdherents">0</span></p>
                <p>Total général : <span id="totalGeneral">0</span> FCFA</p>
            </div>

        </div>

        <div id="analyses" class="tabcontent">
            <h2>Analyses Périodiques</h2>
            <div class="period-selection">
                <label for="period">Période:</label>
                <select id="period">
                    <option value="hebdomadaire">Hebdomadaire</option>
                    <option value="mensuelle">Mensuelle</option>
                    <option value="annuelle" selected>Annuelle</option>
                </select>
            </div>
            <div class="period-selection">
                <label for="annee">Année:</label>
                <select id="annee">
                    <option value="2023" selected>2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <!-- Ajoutez d'autres options d'années si nécessaire -->
                </select>
            </div>
            <div class="period-selection" id="semaineSelection" style="display: none;">
                <label for="semaine">Semaine:</label>
                <select id="semaine">
                    <!-- Options des semaines seront générées dynamiquement -->
                </select>
            </div>
            <div class="period-selection" id="moisSelection" style="display: none;">
                <label for="mois">Mois:</label>
                <select id="mois">
                    <option value="0">Janvier</option>
                    <option value="1">Février</option>
                    <option value="2">Mars</option>
                    <option value="3">Avril</option>
                    <option value="4">Mai</option>
                    <option value="5">Juin</option>
                    <option value="6">Juillet</option>
                    <option value="7">Août</option>
                    <option value="8">Septembre</option>
                    <option value="9">Octobre</option>
                    <option value="10">Novembre</option>
                    <option value="11">Décembre</option>
                </select>
            </div>
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>Opération</th>
                        <th>Total</th> <!-- Afficher seulement "Total" -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Mises</td>
                        <td id="totalMisesPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Prêts</td>
                        <td id="totalPretsPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Remboursements</td>
                        <td id="totalRemboursementsPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Frais de dossier</td>
                        <td id="totalFraisDossierPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Frais d'adhésion</td>
                        <td id="totalFraisAdhesionPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Intérêts</td>
                        <td id="totalInteretsPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Pénalités</td>
                        <td id="totalPenalitesPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Dépôts de tontines</td>
                        <td id="totalDepotsTontinesPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Retraits de tontines</td>
                        <td id="totalRetraitsTontinesPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Tontines</td>
                        <td id="totalTontinesPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Commissions</td>
                        <td id="totalCommissionsPeriode">0 FCFA</td>
                    </tr>
                    <tr>
                        <td>Total Général</td>
                        <td id="totalGeneralPeriode">0 FCFA</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuration de Firebase (remplacez par vos propres informations)
const firebaseConfig = {
  apiKey: "AIzaSyAn4gdgbPBESE1ry9140ngM-Av5hq0kAVQ",
  authDomain: "microfinance-68811.firebaseapp.com",
  databaseURL: "https://microfinance-68811-default-rtdb.firebaseio.com",
  projectId: "microfinance-68811",
  storageBucket: "microfinance-68811.appspot.com",
  messagingSenderId: "328514838296",
  appId: "1:328514838296:web:687b3fa630bcb51e52c86d",
  measurementId: "G-EMJRY7FV2K"
};

// Initialisation de Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();

// Fonction pour ouvrir un onglet
function openTab(evt, tabName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";

  // Appeler les fonctions de chargement des données après l'affichage de l'onglet
  if (tabName === 'details') {
    chargerDetailsAdherentsEtGlobaux();
  } else if (tabName === 'tendances') {
    chargerTendances();
  } else if (tabName === 'operations') {
    chargerListeAdherents();
  } else if (tabName === 'analyses') {
    chargerAnalyses(); // Charger les analyses lorsqu'on affiche l'onglet Analyses
  }
}

// Fonction pour afficher le champ "Type de Tontine" ou "Type de Prêt" en fonction du type d'opération
function afficherTypeOperation() {
  const typeOperation = document.getElementById('typeOperation').value;
  const typeTontineField = document.getElementById('typeTontineField');
  const typePretField = document.getElementById('typePretField');

  if (typeOperation === 'tontine') {
    typeTontineField.style.display = 'block';
    typePretField.style.display = 'none';
    // Masquer les champs de périodicité et de délai de paiement
    document.getElementById('periodiciteField').style.display = 'none';
    document.getElementById('delaiPaiementField').style.display = 'none';
  } else if (typeOperation === 'pret') {
    typePretField.style.display = 'block';
    typeTontineField.style.display = 'none';
    // Appeler afficherPeriodiciteDelai() ici pour afficher les champs si nécessaire
    afficherPeriodiciteDelai(); 
  } else {
    typeTontineField.style.display = 'none';
    typePretField.style.display = 'none';
    // Masquer les champs de périodicité et de délai de paiement
    document.getElementById('periodiciteField').style.display = 'none';
    document.getElementById('delaiPaiementField').style.display = 'none';
  }
}

// Fonction pour afficher les champs de périodicité et de délai de paiement
function afficherPeriodiciteDelai() {
  const typePret = document.getElementById('typePret').value;
  const periodiciteField = document.getElementById('periodiciteField');
  const delaiPaiementField = document.getElementById('delaiPaiementField');

  if (typePret === 'Pret') {
    periodiciteField.style.display = 'block';
    delaiPaiementField.style.display = 'block';
  } else {
    periodiciteField.style.display = 'none';
    delaiPaiementField.style.display = 'none';
  }
}

// Fonction pour afficher la barre de chargement
function showLoading(loadingId) {
  document.getElementById(loadingId).style.display = 'block';
}

// Fonction pour masquer la barre de chargement
function hideLoading(loadingId) {
  document.getElementById(loadingId).style.display = 'none';
}

// Fonction pour mettre à jour la largeur de la barre
function updateLoading(loadingId, width) {
  document.getElementById(loadingId).querySelector('.bar').style.width = width + '%';
}

// Enregistrement d'un adhérent
document.getElementById('adherentForm').addEventListener('submit', function (e) {
  e.preventDefault();
  showLoading('adherentLoading'); // Afficher la barre de chargement

  // Récupérer les informations de l'adhérent
  const adherent = {
    civilite: document.getElementById('civilite').value,
    nom: document.getElementById('nom').value,
    dateNaissance: document.getElementById('dateNaissance').value,
    lieuNaissance: document.getElementById('lieuNaissance').value,
    adresse: document.getElementById('adresse').value,
    telephone: document.getElementById('telephone').value,
    situationMatrimoniale: document.getElementById('situationMatrimoniale').value,
    pieceIdentite: document.getElementById('pieceIdentite').value,
    // Ajouter les informations de la personne à contacter
    contact: {
      nom: document.getElementById('contactNom').value,
      adresse: document.getElementById('contactAdresse').value,
      telephone: document.getElementById('contactTelephone').value,
      pieceIdentite: document.getElementById('contactPieceIdentite').value
    }
  };

  // Stocker les fichiers dans Firebase Storage
  const pieceIdentiteFile = document.getElementById('pieceIdentiteFile').files[0];
  const contactPieceIdentiteFile = document.getElementById('contactPieceIdentiteFile').files[0];

  let pieceIdentiteURL, contactPieceIdentiteURL;
  const storagePromises = [];

  if (pieceIdentiteFile) {
    const pieceIdentiteRef = storage.ref().child(`adherents/${adherent.nom}/piece_identite`);
    storagePromises.push(pieceIdentiteRef.put(pieceIdentiteFile).then(snapshot => snapshot.ref.getDownloadURL()));
  }

  if (contactPieceIdentiteFile) {
    const contactPieceIdentiteRef = storage.ref().child(`adherents/${adherent.nom}/contact_piece_identite`);
    storagePromises.push(contactPieceIdentiteRef.put(contactPieceIdentiteFile).then(snapshot => snapshot.ref.getDownloadURL()));
  }

  // Enregistrer l'adhérent dans la Realtime Database après avoir téléchargé les fichiers
  Promise.all(storagePromises)
    .then(urls => {
      // Ajouter les URL des fichiers à l'objet adhérent
      if (urls[0]) {
        adherent.pieceIdentiteURL = urls[0];
      }
      if (urls[1]) {
        adherent.contact.pieceIdentiteURL = urls[1];
      }

      // Enregistrer l'adhérent dans la Realtime Database
      const adherentsRef = database.ref('adherents');
      const newAdherentRef = adherentsRef.push(); // Créer un nouvel enfant (un nouvel adhérent)

      // Afficher le chemin de l'adhérent dans la console
      console.log("Chemin de l'adhérent:", newAdherentRef.key);

      // Mettre à jour la largeur de la barre de chargement
      updateLoading('adherentLoading', 20);
      setTimeout(() => updateLoading('adherentLoading', 50), 1000);
      setTimeout(() => updateLoading('adherentLoading', 80), 2000);
      setTimeout(() => {
        updateLoading('adherentLoading', 100); // Barre à 100%

        // Enregistrer les données de l'adhérent
        newAdherentRef.set(adherent)
          .then(() => {
            hideLoading('adherentLoading'); // Masquer la barre de chargement
            alert('Adhérent enregistré avec succès!');
            document.getElementById('adherentForm').reset();

            // Mettre à jour les détails après l'enregistrement d'un adhérent
            chargerDetailsAdherentsEtGlobaux();
          })
          .catch((error) => {
            console.error("Erreur lors de l'enregistrement de l'adhérent: ", error);
          });
      }, 3000);
    })
    .catch((error) => {
      console.error("Erreur lors du téléchargement des fichiers: ", error);
    });
});

// Enregistrement d'une opération
document.getElementById('operationForm').addEventListener('submit', function (e) {
  e.preventDefault();
  showLoading('operationLoading'); // Afficher la barre de chargement

  const typeOperation = document.getElementById('typeOperation').value;
  const typeTontine = document.getElementById('typeTontine') ? document.getElementById('typeTontine').value : null;
  const typePret = document.getElementById('typePret') ? document.getElementById('typePret').value : null;
  const periodicite = document.getElementById('periodicite') ? document.getElementById('periodicite').value : null;
  const delaiPaiement = document.getElementById('delaiPaiement') ? document.getElementById('delaiPaiement').value : null;
  let montant = parseFloat(document.getElementById('montant').value);

  // Si le type d'opération est "tontine" et le type de tontine est "Retrait", soustraire le montant du total
  if (typeOperation === 'tontine' && typeTontine === 'Retrait') {
    montant = -montant;
  }

  const operation = {
    type: typeOperation,
    typeTontine: typeTontine,
    typePret: typePret,
    periodicite: periodicite, // Ajouter la périodicité à l'objet operation
    delaiPaiement: delaiPaiement, // Ajouter le délai de paiement à l'objet operation
    adherentId: document.getElementById('adherent').value,
    montant: montant,
    date: document.getElementById('dateOperation').value
  };

  // Mettre à jour la largeur de la barre de chargement
  updateLoading('operationLoading', 20);
  setTimeout(() => updateLoading('operationLoading', 50), 1000);
  setTimeout(() => updateLoading('operationLoading', 80), 2000);
  setTimeout(() => {
    updateLoading('operationLoading', 100); // Barre à 100%

    // Enregistrer l'opération dans la Realtime Database
    const operationsRef = database.ref('operations');
    operationsRef.push(operation) // Enregistrer dans la Realtime Database
      .then(() => {
        hideLoading('operationLoading'); // Masquer la barre de chargement
        alert('Opération enregistrée avec succès!');
        document.getElementById('operationForm').reset();
        // Masquer les champs "Type de Tontine" et "Type de Prêt" après l'enregistrement
        document.getElementById('typeTontineField').style.display = 'none';
        document.getElementById('typePretField').style.display = 'none';
        document.getElementById('periodiciteField').style.display = 'none'; // Masquer le champ de périodicité
        document.getElementById('delaiPaiementField').style.display = 'none'; // Masquer le champ de délai de paiement

        // Mettre à jour les détails après l'enregistrement d'une opération
        chargerDetailsAdherentsEtGlobaux();
        chargerAnalyses(); // Mettre à jour les analyses après l'enregistrement d'une opération
      })
      .catch((error) => {
        console.error("Erreur lors de l'enregistrement de l'opération: ", error);
      });
  }, 3000);
});

// Enregistrement d'un partenaire
document.getElementById('partenaireForm').addEventListener('submit', function (e) {
  e.preventDefault();
  showLoading('partenaireLoading'); // Afficher la barre de chargement

  // Récupérer les informations du partenaire
  const partenaire = {
    nomPartenaire: document.getElementById('nomPartenaire').value,
    montantPartenariat: parseFloat(document.getElementById('montantPartenariat').value),
    datePartenariat: document.getElementById('datePartenariat').value,
    tauxRemuneration: parseFloat(document.getElementById('tauxRemuneration').value),
    dateFin: document.getElementById('dateFin').value
  };

  // Mettre à jour la largeur de la barre de chargement
  updateLoading('partenaireLoading', 20);
  setTimeout(() => updateLoading('partenaireLoading', 50), 1000);
  setTimeout(() => updateLoading('partenaireLoading', 80), 2000);
  setTimeout(() => {
    updateLoading('partenaireLoading', 100); // Barre à 100%

    // Enregistrer le partenaire dans la Realtime Database
    const partenairesRef = database.ref('partenaires');
    partenairesRef.push(partenaire) // Enregistrer dans la Realtime Database
      .then(() => {
        hideLoading('partenaireLoading'); // Masquer la barre de chargement
        alert('Partenaire enregistré avec succès!');
        document.getElementById('partenaireForm').reset();
      })
      .catch((error) => {
        console.error("Erreur lors de l'enregistrement du partenaire: ", error);
      });
  }, 3000);
});

// Charger les détails des adhérents et globaux (combinés)
function chargerDetailsAdherentsEtGlobaux() {
  const adherentsRef = database.ref('adherents');
  const operationsRef = database.ref('operations');

  // Utiliser Promise.all pour s'assurer que les deux lectures de données sont terminées avant de procéder
  Promise.all([
    adherentsRef.once('value'),
    operationsRef.once('value')
  ]).then(([adherentsSnapshot, operationsSnapshot]) => {
    const adherentsData = adherentsSnapshot.val();
    const operationsData = operationsSnapshot.val() || [];
    const detailsTable = document.getElementById('detailsTable').getElementsByTagName('tbody')[0];
    detailsTable.innerHTML = ''; // Vider le tableau avant de le remplir
    let totalGeneralOperations = 0;
    let totalMises = 0;
    let totalPrets = 0;
    let totalRemboursements = 0;
    let totalFraisDossier = 0;
    let totalFraisAdhesion = 0;
    let totalInterets = 0;
    let totalPenalites = 0;
    let totalDepotsTontines = 0;
    let totalRetraitsTontines = 0;
    let totalTontines = 0;
    let totalCommissions = 0;         // Créer un objet pour stocker les totaux de prêts accordés et remboursés par adhérent
    const pretsAdherents = {};

    for (const adherentKey in adherentsData) {
      const adherent = adherentsData[adherentKey];
      let totalMisesAdherent = 0;
      let totalPretsAccordesAdherent = 0; // Total des prêts accordés à l'adhérent
      let totalPretsRembouresAdherent = 0; // Total des prêts remboursés par l'adhérent
      let totalTontinesAdherent = 0;
      let totalFraisAdhesionAdherent = 0;
      let premiereMise = true; // Indicateur pour la première mise

      // Initialiser les totaux de prêts pour l'adhérent
      pretsAdherents[adherent.nom] = {
        accordes: 0,
        rembourses: 0
      };

      for (const operationKey in operationsData) {
        const operation = operationsData[operationKey];
        if (operation.adherentId === adherent.nom) {
          switch (operation.type) {
            case 'mise':
              if (premiereMise) {
                totalCommissions += operation.montant; // Ajouter au total des commissions
                premiereMise = false;
              } else {
                totalMisesAdherent += operation.montant;
                totalMises += operation.montant;
              }
              break;
            case 'pret':
              // Gérer les différents types de prêt
              switch (operation.typePret) {
                case 'Pret':
                  totalPretsAccordesAdherent += operation.montant;
                  pretsAdherents[adherent.nom].accordes += operation.montant;
                  totalPrets += operation.montant;
                  break;
                case 'Remboursement':
                  totalPretsRembouresAdherent += operation.montant;
                  pretsAdherents[adherent.nom].rembourses += operation.montant;
                  totalRemboursements += operation.montant; // Ajouter au total des remboursements
                  // Soustraire le remboursement du total des prêts
                  totalPrets -= operation.montant; 
                  break;
                case 'Interet':
                  totalInterets += operation.montant; // Ajouter au total des intérêts
                  totalPretsAccordesAdherent += operation.montant;
                  pretsAdherents[adherent.nom].accordes += operation.montant;
                  totalPrets += operation.montant;
                  break;
                case 'Penalite':
                  totalPenalites += operation.montant; // Ajouter au total des pénalités
                  totalPretsAccordesAdherent += operation.montant;
                  pretsAdherents[adherent.nom].accordes += operation.montant;
                  totalPrets += operation.montant;
                  break;
                case 'FraisDossier':
                  totalFraisDossier += operation.montant; // Ajouter au total des frais de dossier
                  totalPretsAccordesAdherent += operation.montant;
                  pretsAdherents[adherent.nom].accordes += operation.montant;
                  totalPrets += operation.montant;
                  break;
              }
              break;
            case 'tontine':
              totalTontinesAdherent += operation.montant;
              totalTontines += operation.montant;
              if (operation.typeTontine === 'Depot') {
                totalDepotsTontines += operation.montant;
              } else if (operation.typeTontine === 'Retrait') {
                totalRetraitsTontines += operation.montant; // Attention, le montant est négatif ici
              }
              break;
            case 'FraisAdhesion':
              totalFraisAdhesionAdherent += operation.montant;
              totalFraisAdhesion += operation.montant;
              break;
          }
        }
      }

      // Calculer le total des prêts de l'adhérent en fonction des prêts accordés et remboursés
      let totalPretsAdherent = pretsAdherents[adherent.nom].accordes - pretsAdherents[adherent.nom].rembourses;

      // Vérifier si le total des prêts de l'adhérent est négatif, et le mettre à 0 si c'est le cas
      if (totalPretsAdherent < 0) {
        totalPretsAdherent = 0;
      }

      const totalAdherent = totalMisesAdherent + totalPretsAdherent + totalTontinesAdherent + totalFraisAdhesionAdherent;
      totalGeneralOperations += totalAdherent;

      const row = detailsTable.insertRow();
      row.innerHTML = `
                        <td>${adherent.nom}</td>
                        <td>${totalMisesAdherent} FCFA</td>
                        <td>${totalPretsAdherent} FCFA</td>
                        <td>${totalTontinesAdherent} FCFA</td>
                        <td>${totalAdherent} FCFA</td>
                    `;
    }

    document.getElementById('totalGeneralOperations').textContent = totalGeneralOperations + " FCFA";
    document.getElementById('totalMises').textContent = totalMises + " FCFA";
    document.getElementById('totalPrets').textContent = totalPrets + " FCFA";
    document.getElementById('totalRemboursements').textContent = totalRemboursements + " FCFA";
    document.getElementById('totalFraisDossier').textContent = totalFraisDossier + " FCFA";
    document.getElementById('totalFraisAdhesion').textContent = totalFraisAdhesion + " FCFA";
    document.getElementById('totalInterets').textContent = totalInterets + " FCFA";
    document.getElementById('totalPenalites').textContent = totalPenalites + " FCFA";
    document.getElementById('totalDepotsTontines').textContent = totalDepotsTontines + " FCFA";
    document.getElementById('totalRetraitsTontines').textContent = totalRetraitsTontines + " FCFA"; // Le montant est déjà négatif
    document.getElementById('totalTontines').textContent = totalTontines + " FCFA";
    document.getElementById('totalCommissions').textContent = totalCommissions + " FCFA"; // Afficher le total des commissions dans la section détails globaux
    document.getElementById('totalGeneral').textContent = (totalMises + totalPrets + totalTontines + totalFraisAdhesion) + " FCFA";
    document.getElementById('nombreAdherents').textContent = Object.keys(adherentsData).length;
  }).catch((error) => {
    console.error("Erreur lors du chargement des détails: ", error);
  });
}

// Charger les tendances (à implémenter avec une bibliothèque de graphiques)
function chargerTendances() {
  const operationsRef = database.ref('operations');

  operationsRef.on('value', (snapshot) => {
    const operationsData = snapshot.val() || [];
    const labels = []; // Tableau pour les dates des opérations
    const data = {
      mises: [],
      prets: [],
      tontines: [],
      fraisAdhesion: [], // Ajouter une clé pour les frais d'adhésion
      interets: [], // Ajouter une clé pour les intérêts
      penalites: [], // Ajouter une clé pour les pénalités
      fraisDossier: [] // Ajouter une clé pour les frais de dossier
    };

    for (const operationKey in operationsData) {
      const operation = operationsData[operationKey];
      labels.push(operation.date); // Ajouter la date au tableau des labels

      switch (operation.type) {
        case 'mise':
          data.mises.push(operation.montant);
          break;
        case 'pret':
          // Gérer les différents types de prêt
          switch (operation.typePret) {
            case 'Pret':
              data.prets.push(operation.montant);
              break;
            case 'Remboursement':
              // Ne pas afficher les remboursements dans le graphique
              break;
            case 'Interet':
              data.interets.push(operation.montant);
              break;
            case 'Penalite':
              data.penalites.push(operation.montant);
              break;
            case 'FraisDossier':
              data.fraisDossier.push(operation.montant);
              break;
          }
          break;
        case 'tontine':
          data.tontines.push(operation.montant);
          break;
        case 'FraisAdhesion':
          data.fraisAdhesion.push(operation.montant); // Ajouter les frais d'adhésion aux données du graphique
          break;
      }
    }

    // Créer le graphique avec Chart.js
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'line', // Type de graphique (ligne)
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Mises',
            data: data.mises,
            borderColor: 'blue',
            borderWidth: 1
          },
          {
            label: 'Prêts',
            data: data.prets,
            borderColor: 'red',
            borderWidth: 1
          },
          {
            label: 'Tontines',
            data: data.tontines,
            borderColor: 'green',
            borderWidth: 1
          },
          {
            label: 'Frais d\'Adhésion',
            data: data.fraisAdhesion,
            borderColor: 'purple',
            borderWidth: 1
          },
          {
            label: 'Intérêts',
            data: data.interets,
            borderColor: 'orange',
            borderWidth: 1
          },
          {
            label: 'Pénalités',
            data: data.penalites,
            borderColor: 'brown',
            borderWidth: 1
          },
          {
            label: 'Frais de dossier',
            data: data.fraisDossier,
            borderColor: 'grey',
            borderWidth: 1
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  });
}

// Charger la liste des adhérents pour le formulaire d'opérations
function chargerListeAdherents() {
  const adherentSelect = document.getElementById('adherent');
  adherentSelect.innerHTML = '<option value="">Sélectionnez un adhérent</option>';
  const adherentsRef = database.ref('adherents');

  adherentsRef.on('value', (snapshot) => {
    const adherentsData = snapshot.val();
    if (adherentsData) {
      for (const adherentKey in adherentsData) {
        const adherent = adherentsData[adherentKey];
        const option = document.createElement('option');
        option.value = adherent.nom; // Stocke le nom de l'adhérent comme valeur
        option.text = adherent.nom; // Affiche le nom dans la liste déroulante
        adherentSelect.appendChild(option);
      }
    }
  });
}

// Fonction pour récupérer les images de Firebase Storage et les afficher dans le carrousel
function afficherImages() {
  const storageRef = firebase.storage().ref();
  const imagesRef = storageRef.child('Image Accueil'); // Remplacez 'images' par le chemin de votre dossier d'images dans Firebase Storage

  imagesRef.listAll().then(res => {
    let loadedImages = 0; // Compteur d'images chargées

    res.items.forEach(itemRef => {
      itemRef.getDownloadURL().then(url => {
        // Créer une image pour chaque URL
        const img = document.createElement('img');
        img.src = url;
        img.alt = "Image from Firebase Storage"; // Ajouter un attribut alt
        document.getElementById('imageCarousel').appendChild(img);

        // Incrémenter le compteur d'images chargées
        loadedImages++;

        // Démarrer le carrousel une fois toutes les URLs récupérées
        if (loadedImages === res.items.length) {
          demarrerCarousel();
        }
      });
    });
  }).catch(error => {
    console.error("Erreur lors de la récupération des images:", error);
  });
}

// Fonction pour démarrer le carrousel d'images
function demarrerCarousel() {
  let currentImageIndex = 0;
  const images = document.querySelectorAll('#imageCarousel img');
  images[0].classList.add('active'); // Afficher la première image initialement

  function changerImage() {
    // Masquer l'image actuelle
    images[currentImageIndex].classList.remove('active');

    // Passer à l'image suivante
    currentImageIndex = (currentImageIndex + 1) % images.length;

    // Afficher la nouvelle image
    images[currentImageIndex].classList.add('active');

    // Appeler changerImage() à nouveau avec un délai de 5 secondes
    setTimeout(changerImage, 5000); // Changer d'image toutes les 5 secondes (5000 millisecondes)
  }

  // Appeler changerImage() pour la première fois
  changerImage();
}

// Appeler la fonction pour afficher les images après le chargement de la page
document.addEventListener('DOMContentLoaded', (event) => {
  openTab({ currentTarget: document.querySelector('.tablinks') }, 'adherents');
  afficherImages();
});

function afficherDetailsGlobaux() {
  document.getElementById('detailsGlobaux').style.display = 'block';
}

// Fonction pour charger les analyses périodiques
function chargerAnalyses() {
  const operationsRef = database.ref('operations');
  const periodSelect = document.getElementById('period');
  const anneeSelect = document.getElementById('annee');
  const semaineSelect = document.getElementById('semaine');
  const moisSelect = document.getElementById('mois');

  // Fonction pour calculer les totaux en fonction de la période
  function calculerTotaux(operationsData, periode, annee, semaine = null, mois = null) {
    let totalMises = 0;
    let totalPrets = 0;
    let totalRemboursements = 0;
    let totalFraisDossier = 0;
    let totalFraisAdhesion = 0;
    let totalInterets = 0;
    let totalPenalites = 0;
    let totalDepotsTontines = 0;
    let totalRetraitsTontines = 0;
    let totalTontines = 0;
    let totalCommissions = 0;

    for (const operationKey in operationsData) {
      const operation = operationsData[operationKey];
      const dateOperation = new Date(operation.date);

      // Filtrage des opérations en fonction de la période et de l'année
      if (dateOperation.getFullYear() === parseInt(annee)) {
        if (periode === 'hebdomadaire' && semaine !== null) {
          if (dateOperation.getWeek() === semaine) {
            switch (operation.type) {
              case 'mise':
                totalMises += operation.montant;
                break;
              case 'pret':
                switch (operation.typePret) {
                  case 'Pret':
                    totalPrets += operation.montant;
                    break;
                  case 'Remboursement':
                    totalRemboursements += operation.montant;
                    break;
                  case 'Interet':
                    totalInterets += operation.montant;
                    break;
                  case 'Penalite':
                    totalPenalites += operation.montant;
                    break;
                  case 'FraisDossier':
                    totalFraisDossier += operation.montant;
                    break;
                }
                break;
              case 'tontine':
                totalTontines += operation.montant;
                if (operation.typeTontine === 'Depot') {
                  totalDepotsTontines += operation.montant;
                } else if (operation.typeTontine === 'Retrait') {
                  totalRetraitsTontines += operation.montant;
                }
                break;
              case 'FraisAdhesion':
                totalFraisAdhesion += operation.montant;
                break;
            }
          }
        } else if (periode === 'mensuelle' && mois !== null) {
          if (dateOperation.getMonth() === mois) {
            switch (operation.type) {
              case 'mise':
                totalMises += operation.montant;
                break;
              case 'pret':
                switch (operation.typePret) {
                  case 'Pret':
                    totalPrets += operation.montant;
                    break;
                  case 'Remboursement':
                    totalRemboursements += operation.montant;
                    break;
                  case 'Interet':
                    totalInterets += operation.montant;
                    break;
                  case 'Penalite':
                    totalPenalites += operation.montant;
                    break;
                  case 'FraisDossier':
                    totalFraisDossier += operation.montant;
                    break;
                }
                break;
              case 'tontine':
                totalTontines += operation.montant;
                if (operation.typeTontine === 'Depot') {
                  totalDepotsTontines += operation.montant;
                } else if (operation.typeTontine === 'Retrait') {
                  totalRetraitsTontines += operation.montant;
                }
                break;
              case 'FraisAdhesion':
                totalFraisAdhesion += operation.montant;
                break;
            }
          }
        } else if (periode === 'annuelle') {
          switch (operation.type) {
            case 'mise':
              totalMises += operation.montant;
              break;
            case 'pret':
              switch (operation.typePret) {
                case 'Pret':
                  totalPrets += operation.montant;
                  break;
                case 'Remboursement':
                  totalRemboursements += operation.montant;
                  break;
                case 'Interet':
                  totalInterets += operation.montant;
                  break;
                case 'Penalite':
                  totalPenalites += operation.montant;
                  break;
                case 'FraisDossier':
                  totalFraisDossier += operation.montant;
                  break;
              }
              break;
            case 'tontine':
              totalTontines += operation.montant;
              if (operation.typeTontine === 'Depot') {
                totalDepotsTontines += operation.montant;
              } else if (operation.typeTontine === 'Retrait') {
                totalRetraitsTontines += operation.montant;
              }
              break;
            case 'FraisAdhesion':
              totalFraisAdhesion += operation.montant;
              break;
          }
        }
      }
    }
    return {
      totalMises: totalMises,
      totalPrets: totalPrets,
      totalRemboursements: totalRemboursements,
      totalFraisDossier: totalFraisDossier,
      totalFraisAdhesion: totalFraisAdhesion,
      totalInterets: totalInterets,
      totalPenalites: totalPenalites,
      totalDepotsTontines: totalDepotsTontines,
      totalRetraitsTontines: totalRetraitsTontines,
      totalTontines: totalTontines,
      totalCommissions: totalCommissions
    };
  }

  // Listener pour les changements de période
  periodSelect.addEventListener('change', () => {
    const selectedPeriod = periodSelect.value;
    const selectedAnnee = parseInt(anneeSelect.value);
    const selectedSemaine = parseInt(semaineSelect.value);
    const selectedMois = parseInt(moisSelect.value);
    const semaineSelection = document.getElementById('semaineSelection');
    const moisSelection = document.getElementById('moisSelection');

    if (selectedPeriod === 'hebdomadaire') {
      semaineSelection.style.display = 'block';
      moisSelection.style.display = 'none';
      // Générer les options de semaine pour l'année sélectionnée
      genererOptionsSemaine(selectedAnnee); 
    } else if (selectedPeriod === 'mensuelle') {
      semaineSelection.style.display = 'none';
      moisSelection.style.display = 'block';
    } else {
      semaineSelection.style.display = 'none';
      moisSelection.style.display = 'none';
    }

    operationsRef.once('value').then(snapshot => {
      const operationsData = snapshot.val() || [];
      const totaux = calculerTotaux(operationsData, selectedPeriod, selectedAnnee, selectedSemaine, selectedMois);

      document.getElementById('totalMisesPeriode').textContent = totaux.totalMises + " FCFA";
      document.getElementById('totalPretsPeriode').textContent = totaux.totalPrets + " FCFA";
      document.getElementById('totalRemboursementsPeriode').textContent = totaux.totalRemboursements + " FCFA";
      document.getElementById('totalFraisDossierPeriode').textContent = totaux.totalFraisDossier + " FCFA";
      document.getElementById('totalFraisAdhesionPeriode').textContent = totaux.totalFraisAdhesion + " FCFA";
      document.getElementById('totalInteretsPeriode').textContent = totaux.totalInterets + " FCFA";
      document.getElementById('totalPenalitesPeriode').textContent = totaux.totalPenalites + " FCFA";
      document.getElementById('totalDepotsTontinesPeriode').textContent = totaux.totalDepotsTontines + " FCFA";
      document.getElementById('totalRetraitsTontinesPeriode').textContent = totaux.totalRetraitsTontines + " FCFA";
      document.getElementById('totalTontinesPeriode').textContent = totaux.totalTontines + " FCFA";
      document.getElementById('totalCommissionsPeriode').textContent = totaux.totalCommissions + " FCFA";
      document.getElementById('totalGeneralPeriode').textContent = (totaux.totalMises + totaux.totalPrets + totaux.totalTontines + totaux.totalFraisAdhesion) + " FCFA";
    });
  });

  // Listener pour les changements d'année
  anneeSelect.addEventListener('change', () => {
    const selectedPeriod = periodSelect.value;
    const selectedAnnee = parseInt(anneeSelect.value);
    const selectedSemaine = parseInt(semaineSelect.value);
    const selectedMois = parseInt(moisSelect.value);

    operationsRef.once('value').then(snapshot => {
      const operationsData = snapshot.val() || [];
      const totaux = calculerTotaux(operationsData, selectedPeriod, selectedAnnee, selectedSemaine, selectedMois);

      document.getElementById('totalMisesPeriode').textContent = totaux.totalMises + " FCFA";
      document.getElementById('totalPretsPeriode').textContent = totaux.totalPrets + " FCFA";
      document.getElementById('totalRemboursementsPeriode').textContent = totaux.totalRemboursements + " FCFA";
      document.getElementById('totalFraisDossierPeriode').textContent = totaux.totalFraisDossier + " FCFA";
      document.getElementById('totalFraisAdhesionPeriode').textContent = totaux.totalFraisAdhesion + " FCFA";
      document.getElementById('totalInteretsPeriode').textContent = totaux.totalInterets + " FCFA";
      document.getElementById('totalPenalitesPeriode').textContent = totaux.totalPenalites + " FCFA";
      document.getElementById('totalDepotsTontinesPeriode').textContent = totaux.totalDepotsTontines + " FCFA";
      document.getElementById('totalRetraitsTontinesPeriode').textContent = totaux.totalRetraitsTontines + " FCFA";
      document.getElementById('totalTontinesPeriode').textContent = totaux.totalTontines + " FCFA";
      document.getElementById('totalCommissionsPeriode').textContent = totaux.totalCommissions + " FCFA";
      document.getElementById('totalGeneralPeriode').textContent = (totaux.totalMises + totaux.totalPrets + totaux.totalTontines + totaux.totalFraisAdhesion) + " FCFA";
    });
  });

  // Listener pour les changements de semaine
  semaineSelect.addEventListener('change', () => {
    const selectedPeriod = periodSelect.value;
    const selectedAnnee = parseInt(anneeSelect.value);
    const selectedSemaine = parseInt(semaineSelect.value);
    const selectedMois = parseInt(moisSelect.value);

    operationsRef.once('value').then(snapshot => {
      const operationsData = snapshot.val() || [];
      const totaux = calculerTotaux(operationsData, selectedPeriod, selectedAnnee, selectedSemaine, selectedMois);

      document.getElementById('totalMisesPeriode').textContent = totaux.totalMises + " FCFA";
      document.getElementById('totalPretsPeriode').textContent = totaux.totalPrets + " FCFA";
      document.getElementById('totalRemboursementsPeriode').textContent = totaux.totalRemboursements + " FCFA";
      document.getElementById('totalFraisDossierPeriode').textContent = totaux.totalFraisDossier + " FCFA";
      document.getElementById('totalFraisAdhesionPeriode').textContent = totaux.totalFraisAdhesion + " FCFA";
      document.getElementById('totalInteretsPeriode').textContent = totaux.totalInterets + " FCFA";
      document.getElementById('totalPenalitesPeriode').textContent = totaux.totalPenalites + " FCFA";
      document.getElementById('totalDepotsTontinesPeriode').textContent = totaux.totalDepotsTontines + " FCFA";
      document.getElementById('totalRetraitsTontinesPeriode').textContent = totaux.totalRetraitsTontines + " FCFA";
      document.getElementById('totalTontinesPeriode').textContent = totaux.totalTontines + " FCFA";
      document.getElementById('totalCommissionsPeriode').textContent = totaux.totalCommissions + " FCFA";
      document.getElementById('totalGeneralPeriode').textContent = (totaux.totalMises + totaux.totalPrets + totaux.totalTontines + totaux.totalFraisAdhesion) + " FCFA";
    });
  });

  // Listener pour les changements de mois
  moisSelect.addEventListener('change', () => {
    const selectedPeriod = periodSelect.value;
    const selectedAnnee = parseInt(anneeSelect.value);
    const selectedSemaine = parseInt(semaineSelect.value);
    const selectedMois = parseInt(moisSelect.value);

    operationsRef.once('value').then(snapshot => {
      const operationsData = snapshot.val() || [];
      const totaux = calculerTotaux(operationsData, selectedPeriod, selectedAnnee, selectedSemaine, selectedMois);

      document.getElementById('totalMisesPeriode').textContent = totaux.totalMises + " FCFA";
      document.getElementById('totalPretsPeriode').textContent = totaux.totalPrets + " FCFA";
      document.getElementById('totalRemboursementsPeriode').textContent = totaux.totalRemboursements + " FCFA";
      document.getElementById('totalFraisDossierPeriode').textContent = totaux.totalFraisDossier + " FCFA";
      document.getElementById('totalFraisAdhesionPeriode').textContent = totaux.totalFraisAdhesion + " FCFA";
      document.getElementById('totalInteretsPeriode').textContent = totaux.totalInterets + " FCFA";
      document.getElementById('totalPenalitesPeriode').textContent = totaux.totalPenalites + " FCFA";
      document.getElementById('totalDepotsTontinesPeriode').textContent = totaux.totalDepotsTontines + " FCFA";
      document.getElementById('totalRetraitsTontinesPeriode').textContent = totaux.totalRetraitsTontines + " FCFA";
      document.getElementById('totalTontinesPeriode').textContent = totaux.totalTontines + " FCFA";
      document.getElementById('totalCommissionsPeriode').textContent = totaux.totalCommissions + " FCFA";
      document.getElementById('totalGeneralPeriode').textContent = (totaux.totalMises + totaux.totalPrets + totaux.totalTontines + totaux.totalFraisAdhesion) + " FCFA";
    });
  });

  // Appeler la fonction pour charger les totaux initiaux (annuels par défaut)
  chargerAnalyses();

  // Générer les options de semaine au chargement de la page
  genererOptionsSemaine(parseInt(anneeSelect.value)); // Générer les options pour l'année sélectionnée par défaut
}

// Fonction pour obtenir la semaine de l'année
Date.prototype.getWeek = function() {
  const date = new Date(this.getFullYear(), this.getMonth(), this.getDate());
  const dayNum = (date.getDay() + 6) % 7;
  const firstDay = new Date(this.getFullYear(), 0, 1);
  const dayNumFirstDay = (firstDay.getDay() + 6) % 7;
  const dayCount = Math.round(((date.getTime() - firstDay.getTime()) / (1000 * 60 * 60 * 24)) + 1);
  return Math.ceil((dayCount + dayNumFirstDay - 1) / 7);
}

// Fonction pour générer les options de semaine dynamiquement
function genererOptionsSemaine(annee) {
  const semaineSelect = document.getElementById('semaine');
  semaineSelect.innerHTML = ''; // Vide les options existantes

  const premiereSemaine = new Date(annee, 0, 1).getWeek(); // Semaine de la première journée de l'année
  const derniereSemaine = new Date(annee, 11, 31).getWeek(); // Semaine de la dernière journée de l'année

  for (let semaine = premiereSemaine; semaine <= derniereSemaine; semaine++) {
    const option = document.createElement('option');
    option.value = semaine;
    option.text = `Semaine ${semaine}`;
    semaineSelect.appendChild(option);
  }
}

// Appeler la fonction pour afficher les images après le chargement de la page
document.addEventListener('DOMContentLoaded', (event) => {
  openTab({ currentTarget: document.querySelector('.tablinks') }, 'adherents');
  afficherImages();
});

function afficherDetailsGlobaux() {
  document.getElementById('detailsGlobaux').style.display = 'block';
}
    </script>

</body>
</html>
